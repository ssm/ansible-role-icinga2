---
- name: Set variables
  set_fact:
    icinga2_ido_host: "{{ icinga2_ido_host | default(icinga2_default_ido_host) }}"
    icinga2_ido_database: "{{ icinga2_ido_database | default(icinga2_default_ido_database) }}"
    icinga2_ido_user: "{{ icinga2_ido_user | default(icinga2_default_ido_user) }}"
    icinga2_ido_password: "{{ icinga2_ido_password | default(icinga2_default_ido_password) }}"

- name: Sanity check
  assert:
    that:
      - icinga2_ido_host is defined
      - icinga2_ido_database is defined
      - icinga2_ido_user is defined
      - icinga2_ido_password is defined

- name: Ensure package is installed
  package:
    name: icinga2-ido-pgsql
    state: present
  register: _package

- name: Enable ido-pgsql feature
  command:
  args:
    argv:
      - icinga2
      - feature
      - enable
      - ido-pgsql
    creates: /etc/icinga2/features-enabled/ido-pgsql.conf
  environment:
    PGPASSWORD: "{{ icinga2_ido_password }}"
  register: _feature

- name: Ensure idoutils schema is loaded
  become: true
  become_user: "{{ icinga2_service_user }}"
  block:
    - name: Check icinga2-ido schema presence
      command:
      args:
        argv:
          - psql
          - -h
          - "{{ icinga2_ido_host }}"
          - -U
          - "{{ icinga2_ido_user }}"
          - -d
          - "{{ icinga2_ido_database }}"
          - -A
          - -t
          - -c
          - select count(name) from icinga_dbversion where name = 'idoutils'
      environment:
        PGPASSWORD: "{{ icinga2_ido_password }}"
      register: _dbversion
      changed_when: false
      failed_when: false
      check_mode: false

    - name: Load icinga2-ido schema
      become_user: "{{ icinga2_service_user }}"
      command:
      args:
        argv:
          - psql
          - -h
          - "{{ icinga2_ido_host }}"
          - -U
          - "{{ icinga2_ido_user }}"
          - -d
          - "{{ icinga2_ido_database }}"
          - -f
          - /usr/share/icinga2-ido-pgsql/schema/pgsql.sql
      environment:
        PGPASSWORD: "{{ icinga2_ido_password }}"
      when: _dbversion.stdout != "1"
      register: _schema

- name: Reload icinga2 configuration
  service:
    name: icinga2
    state: reloaded
  when: _package.changed or _feature.changed or _schema.changed
